# 高级数据库课程设计小组详细分工方案 v2.0
## 项目名称：PlayEdu 企业级在线培训系统深度优化与扩展

---

## 📅 项目概述与目标
本项目基于开源 Java 项目 `PlayEdu` 进行深度二次开发。作为一个企业级培训系统，其核心业务涵盖了**学员管理、部门组织、课程资源管理、学习进度追踪**以及**多维度的统计分析**。

本次课程设计的目标不仅仅是功能迭代，而是将 **“高级数据库技术”** 融入到实际的软件工程中。我们将模拟**十万级学员、百万级日志**的业务场景，通过前后端全栈开发配合数据库的高级特性（存储过程、视图、触发器、索引优化、事务控制），解决实际的性能与数据一致性问题。

---

## 👥 团队分工矩阵

| 成员 | 角色定位 | 负责的业务模块 (表) | 数据库核心任务 (DB) | 前后端开发任务 (Dev) | 任务权重 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **成员 A** | **架构与用户中心负责人** | `users`, `departments`, `admin_users` | 递归查询、视图封装、外键策略 | 学员/部门管理、批量导入 | ⭐⭐⭐⭐⭐ |
| **成员 B** | **课程资源核心负责人** | `courses`, `resource`, `course_attachment` | 事务一致性、存储过程、级联处理 | 课程发布流程、文件上传 | ⭐⭐⭐⭐⭐ |
| **成员 C** | **数据统计与分析专家** | `user_learn_duration_stats`, `dashboard` | 复杂聚合、窗口函数、定时结算 | 数据大屏、排行榜组件 | ⭐⭐⭐⭐⭐ |
| **成员 D** | **日志审计与安全负责人** | `user_login_records`, `admin_logs` | 索引优化、分区表设计、Fulltext索引 | 日志审计页、登录安全 | ⭐⭐⭐⭐⭐ |

---

## 🛠 详细任务拆解书

### 🧑‍💻 成员 A：架构与用户中心负责人
**核心领域：复杂组织架构数据处理与视图封装**
**涉及表**：`users` (学员), `departments` (部门), `admin_users` (管理员), `user_department` (关联表)

#### 1. [DB-高级] 部门层级树的递归查询优化
*   **背景**：企业部门是无限层级的树状结构（父部门包含子部门），现有简单 SQL 难以查询“某部门及其所有子部门下的所有员工”。
*   **任务**：
    *   **CTE 递归查询**：利用 MySQL 8.0 的 **Common Table Expressions (WITH RECURSIVE)** 编写 SQL，输入一个部门 ID，自动递归查出所有子部门 ID 列表。
    *   **视图封装 (View)**：创建视图 `v_user_full_detail`，将 flat 扁平化的用户表与递归后的部门路径（如 "技术部-后端组"）进行关联，简化应用层查询。

#### 2. [DB-高级] 数据一致性保护 (Trigger)
*   **背景**：学员被删除时，其关联在 `user_department` 表的数据需要处理，且为了数据留痕，不能物理删除学员，只能“软删除”。
*   **任务**：
    *   **Trigger 设计**：编写 `BEFORE DELETE` 触发器，拦截对 `users` 表的物理删除操作，改为更新 `is_deleted = 1`，并自动记录删除操作的时间和操作人到 `audit_user_changes` 表（需新建此表）。

#### 3. [Dev-全栈] 学员与部门管理模块
*   **后端 (Spring Boot)**：
    *   重构 `UserController`，集成上述的递归部门查询逻辑。
    *   实现 **Excel 批量导入学员** 功能，在 Service 层处理数千条数据的批量插入，并保证部门不存在时自动创建的逻辑。
*   **前端 (React)**：
    *   **部门树组件**：开发左侧可拖拽、可折叠的部门树形控件。
    *   **学员表格**：实现带复杂筛选（按部门递归筛选、按状态筛选）的高级表格。

---

### 🧑‍💻 成员 B：课程资源核心负责人
**核心领域：复杂业务事务控制与存储过程**
**涉及表**：`courses` (课程), `course_chapters` (章节), `resource` (上传文件), `course_attachment` (课件)

#### 1. [DB-高级] 课程发布原子性事务 (Transaction)
*   **背景**：发布一门课程涉及：插入课程主表、插入章节表、插入课时表、关联资源表。任何一步失败都必须回滚，否则会产生“僵尸课程”。
*   **任务**：
    *   **事务隔离级别验证**：设计测试用例，在 `READ COMMITTED` 和 `REPEATABLE READ` 下测试并发创建课程时的插入异常。
    *   **级联删除存储过程**：编写存储过程 `sp_delete_course_cascade(course_id)`，逻辑严密地按顺序删除：课时关联 -> 章节 -> 课程附件 -> 课程主体，确保外键约束不会报错。

#### 2. [DB-高级] 资源引用计数与清理
*   **背景**：`resource` 表存储了视频/图片文件信息。当课程删除时，如果资源未被其他课程引用，应标记为“可清理”。
*   **任务**：
    *   **复杂更新 SQL**：编写 SQL 定期扫描 `resource` 表，通过 `LEFT JOIN` `course_hour` 表查找引用计数为 0 的孤立资源，并标记 `status = 'orphan'`。

#### 3. [Dev-全栈] 课程编排系统
*   **后端 (Spring Boot)**：
    *   开发“课程-章节-课时”的嵌套保存接口 (`@Transactional` 注解的深度应用)。
    *   资源上传接口：集成 MinIO/OSS SDK，并在数据库记录文件元数据（大小、时长、类型）。
*   **前端 (React)**：
    *   **分步表单**：开发 StepForm（基本信息 -> 章节编排 -> 课件配置 -> 发布）。
    *   **资源选择器**：弹窗形式的资源库文件选择组件，支持按文件类型过滤。

---

### 🧑‍💻 成员 C：数据统计与分析专家
**核心领域：海量数据聚合、OLAP 分析与可视化**
**涉及表**：`user_learn_duration_stats` (每日学习时长), `user_course_records` (选课记录), `user_quiz_records` (测验记录)

#### 1. [DB-高级] 复杂报表与窗口函数 (Window Functions)
*   **背景**：现有的排行榜只按总量排名。业务部门需要更精细的“部门内部排名”和“环比增长”。
*   **任务**：
    *   **部门内排名 (RANK)**：使用 `RANK() OVER (PARTITION BY dept_id ORDER BY duration DESC)` SQL，计算每个学员在其所属部门内的排名。
    *   **学习趋势分析**：使用 `DATE_FORMAT` 和 `GROUP BY`，统计已选课学员在过去 30 天的每日平均学习时长趋势，并计算周同比 (WoW)。

#### 2. [DB-高级] 每日结算定时任务 (Event Scheduler)
*   **背景**：`user_learn_duration_stats` 表随着时间推移数据量会暴增。实时统计查询会变慢。
*   **任务**：
    *   **汇总表设计**：设计 `stat_daily_summary` 表。
    *   **MySQL Event**：编写 MySQL Event `evt_daily_settle`，每天凌晨 02:00 运行，将前一天的明细数据汇总（SUM/AVG）写入汇总表，供报表快速查询。

#### 3. [Dev-全栈] 数据可视化大屏
*   **后端 (Spring Boot)**：
    *   实现 `DashboardController` 的高级接口：部门学习力对比（雷达图数据）、学员活跃时段分布（热力图数据）。
    *   接口缓存：对这些计算量大的接口增加 Redis 缓存支持。
*   **前端 (React)**：
    *   **ECharts 深度集成**：开发可视化 Dashboard，包含折线图（趋势）、饼图（资源分布）、柱状图（部门对比）。
    *   **排行榜组件**：复用并增强现有的排行榜，增加“昨日/本周/本月”的时间维度切换。

---

### 🧑‍💻 成员 D：日志审计与安全负责人
**核心领域：海量日志性能优化与全文检索**
**涉及表**：`user_login_records` (登录日志), `admin_logs` (操作审计), `system_config` (系统配置)

#### 1. [DB-高级] 百万级日志表性能优化
*   **背景**：系统运行一年后，登录日志表可能达到百万级，查询“某用户最近登录记录”变慢。
*   **任务**：
    *   **索引优化实战**：插入 100 万条模拟日志数据。对比无索引、单列索引、联合索引 (`user_id`, `created_at`) 下的查询执行计划 (`EXPLAIN`) 和耗时。
    *   **表分区 (Partitioning)**：设计按月 (`RANGE`) 分区的策略，将日志表拆分为 `logs_202301`, `logs_202302`...，演示分区剪枝 (Partition Pruning) 带来的查询性能提升。

#### 2. [DB-高级] 操作日志全文检索
*   **背景**：管理员需要搜寻“谁修改了积分配置”这类模糊操作日志。
*   **任务**：
    *   **Fulltext Index**：对 `admin_logs` 表的 `content` 字段建立 MySQL 全文索引（或使用 `LIKE` 优化的替代方案），实现高效的关键词搜索。

#### 3. [Dev-全栈] 安全审计中心
*   **后端 (Spring Boot)**：
    *   **AOP 切面日志**：编写 Java AOP 切面，拦截所有 `@Log` 注解的操作，异步写入数据库，不影响主业务性能。
    *   IP 地理位置解析：在登录日志记录时，解析 IP 归属地并存入数据库。
*   **前端 (React)**：
    *   **审计日志查询页**：带时间范围选择器的高级查询页面。
    *   **系统配置页**：实现对系统名称、LOGO、默认密码等参数的配置管理与持久化。

---

## � 交付物清单
1.  **数据库设计说明书 (DDL + ER图)** - 包含所有新加的索引、分区、视图定义。
2.  **高级 SQL 脚本库** - 收录所有写的存储过程、触发器、CTE 递归查询 SQL。
3.  **性能优化测试报告** - 记录成员 B 和 D 进行索引优化前后的 QPS/响应时间对比数据。
4.  **系统源码** - 前后端完整可运行代码。
5.  **可视化演示录屏** - 重点展示仪表盘动态效果和大数据量下的查询响应。
